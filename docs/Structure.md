# 整个项目架构

## 重新思考整个程序的架构（2024-07-25）

暂时考虑放弃禁则计算，用了新的高度计算方案之后，计算速度还不错，我认为可以继续推进基础功能了。还有一点比较重要的，整个APP的架构需要梳理一下了，感觉用起来很混乱。我希望架构能够简单易用，现有的按照组件划分，如下

1. 书架-书架又包含着书籍管理
2. 阅读器-阅读器专注于阅读，同时也有对应的UI

在组件之外还有两个重要部分

1. 数据库-书本增删改查
2. 同步-待设计实现

现在用起来真的是不够清晰，甚至说，有些过于复杂了，而且考虑到后面可能需要支持epub，我的项目入口，包括导入，甚至我的阅读器都需要重新考虑……
如果说纯文本，现有的Book接口还算够用，当涉及到epub的时候，有CSS和HTML，如果不单独写渲染部分，不知道咋办。
但是，UI部分又是通用的……这方面可以考虑看看foliaate里的思路（我不太擅长面向对象啊，也不太擅长编程……）
更外一层，哪些应该同步，哪些应该异步？我的整个app，核心部分需要简单并且稳定，然后扩展部分则支持更多。
这是一个电子书架，他可以放入各种不同格式的书籍，也能支持阅读不同格式的书籍，同时提供一套统一的阅读，时间记录，批注的体验（参考微信读书）
这样说来，我的核心就是书架，不同格式书籍的导入需要一一实现，阅读也需要一一实现，然后书签，时间记录，批注划线等功能，依靠统一UI调用具体的实现。

### Reader和ReaderUI的抽象类

```javascript
// 阅读器抽象类
abstract class Reader {
    // 翻页，例如上一页下一页，或者滚动
    changePage() {

    },
    // 切换章节
    changeChapter() {

    }，
    // 阅读位置记录（书签）
    savePosi() {

    }，
    // 加载
    load() {
        // onMounted?
    },
    refresh() {
        // 
    },

}
// 阅读器UI，啥也不知道，只会两个，调用Reader提供的api，还有就是展示Reader提供的信息
abstract class ReaderUI {
    scroll() {
        // 滚动，或许触发翻页（滚动加载）
    }，
    move() {
        // 滑动，左滑右滑，触发左右翻页
    }，
    jump() {
        // 章节跳转
    }，
    justifyConfig() {
        // 修改文字大小，字体
    }，
    showChapterProgress() {
        // 展示章节进度
    }，
    showTotalProgress() {
        // 展示全本进度
    }
}
```
### 核心组件的定位

IndexDB,核心之一，但是较为简单：提供新增修改删除查找书籍功能

Reader，毋庸置疑的核心之一，首要功能：

1. 读取解析书籍内容，并展示
2. 读取解析章节信息
3. 实现具体的操作
    1. 翻页（无论是滚动，还是水平）
    2. 章节跳转
    3. 书签记录管理
    4. 批注和划线管理

### 借助epubcfi，实现书签，批注，高亮

第三点和第四点可能可以仔细想想，让他更为通用一点，比如参考epubcfi规范，能绝对准确的指出书籍中某部分内容，
无论是书签，批注，还是高亮，其实本质都是指定一个具体位置，然后Reader可以对这个位置进行各种操作
1. 记录位置，并支持跳转（也就是书签）
2. 记录位置，并在渲染的时候，额外的对被记录位置操作
```HTML
这是正常的，普通的一段话
<p>
    Hello World!
</p>
这是带批注的(加粗)
<p id="book:光之子;chapter:第三十章-遇见木子;paraIdx:第多少段;range(a,b)第几个字到第几个字">
    <span class="underline">Hello</span>
    <span class="high-light">World</span>
<p>
这里的考虑一个简单方案，正常的渲染过后，检查批注划线内容，如果id对应上了,则额外对这个P进行操作,主要还是把握住唯一性和准确性，
这个id必须能够准确的标识我们所操作的位置。
写入的时候，传递id，记录
读取的时候，辨别id，修饰
同时一定要注意，划线高亮等，绝对不能影响原内容
```

## 适应多端的CSS（2024-08-05）

目前暂时只有一个CSS文件，后续如果有需要，会考虑通过媒体查询加载多套CSS（PC,手机，平板）

## epub格式到底如何支持？
现在有两个选择，一个可能简单点。
先说简单的，导入epub并解析整个目录以及内容，按照现有的Book接口，提取`chapterArray`,`paraArray`,并且按照默认配置计算出`heightArray`。做完这些，就可以把这个epub当作和txt一样的东西，完全兼容现在的txt格式阅读。
但是这个简单的方法，有一个明显的缺点。它不再是完整的epub，而是提取了目录和内容的epub，并且还会有部分隐患。如果epub内部存在图片等非纯文本内容，这也会导致内容不完整。还有就是epub本分附带的css也会随之消失，这很不epub。
再说难弄点的，就是按照之前写的demo，重写`loader`,`render`，并且现有的高度计算方案又完全行不通了，需要另外考虑。

